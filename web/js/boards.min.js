function calc(a){for(var b=1024,c=parseFloat(a),d=0;d<4&&c>=b;d++)c/=b;return toPrec(c,2)+_unit[d]}function switchPrct(a){return isNaN(a)?"0.0 %":(a=parseFloat(a),0===a?"0.0 %":toPrec(a)+" %")}function toPrec(a,b){b||(b=1);var c=Math.pow(10,b);if(a=(Math.round(a*c)/c).toString(),b>0){a.indexOf(".")<0&&(a+=".");var d=a.substring(a.indexOf(".")).length-1;if(d<b)for(var e=0;e<b-d;e++)a+="0"}return a}function switchUndef(a){return void 0===a?"--":a}var _unit=[" B "," KB"," MB"," GB"],HistoryBoard=function(){return{version:"History Board 1.0.0",_content:'<h1 class="page-header"></h1>            <div class="mon-info">                <div class="mon-div cpu-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text long-text">CPU & 内存</div>                    </h2>                    <div id="sys_chart" class="normal-chart"></div>                </div>                <div class="mon-div tps-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text">TPS</div>                    </h2>                    <div id="tps_chart" class="normal-chart"></div>                </div>                <div class="mon-div avr-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text long-text">平均响应时间</div>                    </h2>                    <div id="avr_chart" class="normal-chart"></div>                </div>                <div class="mon-div suc-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text long-text">报文返回成功率</div>                    </h2>                    <div id="suc_chart" class="normal-chart"></div>                </div>            </div>',el:null,dispEl:null,serverName:null,init:function(a){for(var b in this)this.hasOwnProperty(b)&&a[b]&&(this[b]=a[b]);"string"==typeof this.el&&(this.el=$(this.el)),this.el.click(this._open)},_open:function(){"number"==typeof timer&&timer>0&&clearInterval(timer),hisBoard.dispEl&&"string"==typeof hisBoard.dispEl&&(hisBoard.dispEl=$(hisBoard.dispEl)),hisBoard.dispEl.html(hisBoard._content),$("h1.page-header").text("历史记录 - "+currentServer)}}},hisBoard=new HistoryBoard,MainBoard=function(){return{version:"Main Board 1.0.0",_content:'<h1 class="page-header">监控面板</h1>            <h2 class="sub-header">POIN</h2>            <div class="table-responsive">                <table class="table table-striped svr-table">                    <thead>                        <tr>                            <th class="head_align" width="30%">远程服务器</th>                            <th class="head_align" width="12%">CPU使用率</th>                            <th class="head_align" width="12%">内存使用率</th>                            <th class="head_align" width="12%">TPS</th>                            <th class="head_align" width="12%">平均响应时间</th>                            <th class="head_align" width="12%">返回报文成功率</th>                            <th class="head_align" width="10%">状态</th>                        </tr>                    </thead>                    <tbody>${content}</tbody>                </table>            </div>',interval:6e4,navCallback:null,nav:null,summaryEl:null,summaryCallback:null,historyEl:null,_timer:0,init:function(a){for(var b in this)this.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(this[b]=a[b]);this._loadScript(),this.navigator(),this.summary(),this._initHistory(),this._timer=setInterval(function(){mboard.summary()},this.interval)},_scripts:["charts/loader.js","charts/monitorchart.js","js/monitorboard.js","js/setboard.js"],_loadScript:function(){for(var a="/static/",b=this._scripts,c=0;c<b.length;c++)$.getScript(a+b[c])},navigator:function(){$.get("/navlist",{},this.navCallback)},navHandler:function(a){var b=$.parseJSON(a),c="";for(var d in b)c+='<li><a href="javascript: void(0);" onclick="mboard.detail(\''+b[d]+"');\">"+b[d]+"</a></li>";var e=this.nav;"string"==typeof e&&(e=$(e)),e.html(c)},summary:function(){$.get("/summary",{type:"poin"},this.summaryCallback)},summaryHandler:function(a){var b,c,d,e=$.parseJSON(a),f="";for(var g in e)b=e[g],c=b.stat,d=b.db,f+='<tr><td class="cell_c">'+b.server+'</td><td class="cell_c">'+switchPrct(c.cpuprct)+'</td><td class="cell_c">'+switchPrct(c.vmem.percent)+'</td><td class="cell_c">'+switchUndef(d.tps)+'</td><td class="cell_c">'+switchUndef(d.avgresp)+'</td><td class="cell_c">'+switchPrct(d.feedsuc)+'</td><td class="cell_c">正常</td></tr>';f=this._content.replace(/\$\{content\}/,f);var h=this.summaryEl;"string"==typeof h&&(h=$(h)),h.html(f)},detail:function(a){clearInterval(mboard._timer),$(".nav.nav-sidebar > li").each(function(){var b=$(this),c=b.children("a");if(c.text()===a){if(b.hasClass("active"))return;b.addClass("active")}else b.removeClass("active")}),monitor.init({dispEl:"div.main",freshCallback:function(a){monitor.express(a)},createCallback:function(a){monitor.create(a)},serverName:a}),$(mboard.historyEl).removeClass("hide")},_initHistory:function(){"string"==typeof this.historyEl&&(this.historyEl=$(this.historyEl)),this.historyEl.click(this.history)},history:function(){monitor.loadHistory()}}},mboard=new MainBoard,MonitorBoard=function(){return{version:"Monitor Board 1.0.0",_content:'<h1 class="page-header"></h1>            <div class="page-btn hide">                <button type="button" class="btn btn-sm btn-primary forward">&lt;&lt; 前4小时</button>                <button type="button" class="btn btn-sm btn-primary backward">后4小时 &gt;&gt;</button>            </div>            <div class="mon-info">                <div class="mon-div cpu-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text">CPU</div>                        <div class="humanized cpu-percent"></div>                        <div class="title-text">内存</div>                        <div class="humanized mem-percent"></div>                    </h2>                    <div id="sys_chart" class="normal-chart"></div>                </div>                <div class="mon-div tps-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text">TPS</div>                        <div class="humanized tps-val"></div>                    </h2>                    <div id="tps_chart" class="normal-chart"></div>                </div>                <div class="mon-div avr-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text long-text">平均响应时间</div>                        <div class="humanized avr-val"></div>                    </h2>                    <div id="avr_chart" class="normal-chart"></div>                </div>                <div class="mon-div suc-info">                    <h2 class="sub-header sub-header-p">                        <div class="title-text long-text">报文返回成功率</div>                        <div class="humanized suc-val"></div>                    </h2>                    <div id="suc_chart" class="normal-chart"></div>                </div>            </div>            <div class="detail-panel">                <div class="cpu-info" style="display: none;">                    <h4>CPU</h4>                    <table class="mon-tab"></table>                </div>                <div class="mem-info" style="display: none;">                    <h4>Memory</h4>                    <table class="mon-tab"></table>                </div>            </div>',dispEl:null,freshCallback:null,createCallback:null,serverName:null,interval:6e4,_timer:0,init:function(a){for(var b in this)this.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(this[b]=a[b]);this._loaded||(this.dispEl&&"string"==typeof this.dispEl&&(this.dispEl=$(this.dispEl)),this.dispEl.html(this._content),$(".btn-primary.forward").click(function(){monitor.loadHistory("f")}),$(".btn-primary.backward").click(function(){monitor.loadHistory("b")})),this._initDisp(),this.fresh(),this._initChart(),this._timer>0&&clearInterval(this._timer),this._timer=setInterval(function(){monitor.fresh()},this.interval)},_initDisp:function(){$("h1.page-header").text(this.serverName),$(".humanized").each(function(){$(this).removeClass("hide")}),$(".page-btn").addClass("hide")},_sysChart:null,_tpsChart:null,_avrChart:null,_sucChart:null,_loaded:!1,create:function(a){a=$.parseJSON(a),this._loaded?this._reloadChart(a):(this._sysChart=mchart({id:"cpu&mem",googleChartOpt:{vAxis:{minValue:0,maxValue:100},lineWidth:.7,areaOpacity:.5,colors:["#418CD8","#899F00"]},dispEl:document.getElementById("sys_chart"),data:a.svr,index:[0,1],illustration:["","CPU","内存"],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._sysChart.draw()}}),this._tpsChart=mchart({id:"tps",googleChartOpt:{vAxis:{minValue:0},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#FF7E40"]},dispEl:document.getElementById("tps_chart"),data:a.db,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._tpsChart.draw()}}),this._avrChart=mchart({id:"averagetime",googleChartOpt:{vAxis:{minValue:0},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#45C098"]},dispEl:document.getElementById("avr_chart"),data:a.db,index:1,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._avrChart.draw()}}),this._sucChart=mchart({id:"successrate",googleChartOpt:{vAxis:{minValue:0,maxValue:100},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#5500AA"]},dispEl:document.getElementById("suc_chart"),data:a.db,index:2,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._sucChart.draw()}}),this._loaded=!0)},_initChart:function(){$.get("/history/"+this.serverName,{},this.createCallback)},_reloadChart:function(a){this._sysChart.reload({data:a.svr,start:a.shour,ctime:[a.ehour,a.eminu]});var b={data:a.db,start:a.shour,ctime:[a.ehour,a.eminu]};this._tpsChart.reload(b),this._avrChart.reload(b),this._sucChart.reload(b)},fresh:function(){$.get("/serverinfo/"+this.serverName,{},this.freshCallback)},_cpu_prct:0,_mem_prct:0,express:function(a){var b=$.parseJSON(a),c=b.stat,d=b.db;this._switchCpu(c),this._switchMem(c.vmem),this._swichQualify(d),this._freshChart(this._sysChart,[this._cpu_prct,this._mem_prct]),this._freshChart(this._tpsChart,d.tps),this._freshChart(this._avrChart,d.avgresp),this._freshChart(this._sucChart,d.feedsuc)},_freshChart:function(a,b){a&&a.loaded&&a.fresh(b)},_switchCpu:function(a){$(".cpu-percent").text(switchPrct(a.cpuprct)),this._cpu_prct=a.cpuprct;var b="",c=a.cputimes;for(var d in c)b+='<tr><th width="100px">'+d+'</th><td class="cell_r">'+toPrec(c[d],2)+"</td></tr>";$(".cpu-info > .mon-tab").html(b)},_mem_dict:["total","used","free"],_switchMem:function(a){$(".mem-percent").text(switchPrct(a.percent)),this._mem_prct=a.percent,delete a.percent;for(var b="",c=this._mem_dict,d=0;d<c.length&&a[c[d]];d++)b+='<tr><th width="100px">'+c[d]+'</th><td class="cell_r">'+calc(a[c[d]])+"</td></tr>",delete a[c[d]];for(var e in a)b+='<tr><th width="100px">'+e+'</th><td class="cell_r">'+calc(a[e])+"</td></tr>";$(".mem-info > .mon-tab").html(b)},_swichQualify:function(a){$(".tps-val").text(switchUndef(a.tps)),$(".avr-val").text(switchUndef(a.avgresp)+" ms"),$(".suc-val").text(switchPrct(a.feedsuc))},_historyStart:"",loadHistory:function(a){void 0===a&&(this._addHistoryTitle(),this._historyStart="",a=""),$.post("/history",['{"svr_nm":"',this.serverName,'","start":"',this._historyStart,'","direct":"',a,'"}'].join(""),function(a){monitor._historyCallback(a)})},_historyCallback:function(a){"string"==typeof a&&(a=$.parseJSON(a)),this._historyStart=a.stime;var b=parseInt(this._historyStart.substring(8,10));0==b?a.shour=20:a.shour=b-4,a.ehour=b,a.eminu=0,this._reloadChart(a)},_addHistoryTitle:function(){clearInterval(this._timer),$("h1.page-header").text("历史记录 - "+this.serverName),$(".humanized").each(function(){$(this).addClass("hide")}),$(".page-btn").removeClass("hide")}}},monitor=new MonitorBoard,SetBoard=function(){};