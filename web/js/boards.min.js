function calc(a){for(var b=1024,c=parseFloat(a),d=0;d<4&&c>=b;d++)c/=b;return toPrec(c,2)+_unit[d]}function switchPrct(a){return isNaN(a)?"--":(a=parseFloat(a),0===a?"0.0 %":toPrec(a)+" %")}function toPrec(a,b){b||(b=1);var c=Math.pow(10,b);if(a=(Math.round(a*c)/c).toString(),b>0){a.indexOf(".")<0&&(a+=".");var d=a.substring(a.indexOf(".")).length-1;if(d<b)for(var e=0;e<b-d;e++)a+="0"}return a}function switchUndef(a){return void 0===a?"--":a}function changeDate(a,b){var c=new Date(a).valueOf();c=new Date(c+864e5*b);var d=1900+c.getYear(),e=c.getMonth()+1,f=c.getDate();return[d,(e<10?"0":"")+e,(f<10?"0":"")+f].join("-")}function verifyIPv4(a){return a.match(_ipv4_regex)}function verifyPort(a){return a=parseInt(a),!isNaN(a)&&a>=0&&a<65536}var _unit=[" B "," KB"," MB"," GB"],_ipv4_regex=/^(?:(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])\.){3}(?:\d|[1-9]\d|1\d{2}|2[0-4]\d|25[0-5])$/,MainBoard=function(){return{version:"Main Board 1.0.0",_content:['<div class="alert alert-danger hide" role="alert">',"<strong>错误！</strong>检测到受控机状态异常，请联系管理员处理。</div>",'<h1 class="page-header">监控面板</h1>','<h2 class="sub-header">POIN</h2>','<div class="table-responsive">','<table class="table table-striped svr-table">',"<thead>","<tr>",'<th class="head_align" width="30%">远程服务器</th>','<th class="head_align" width="12%">CPU使用率</th>','<th class="head_align" width="12%">内存使用率</th>','<th class="head_align" width="12%">TPS</th>','<th class="head_align" width="12%">平均响应时间</th>','<th class="head_align" width="12%">返回报文成功率</th>','<th class="head_align" width="10%">状态</th>',"</tr>","</thead>","<tbody>${content}</tbody>","</table>","</div>"].join(""),interval:6e4,navCallback:null,nav:null,summaryEl:null,summaryCallback:null,historyEl:null,setEl:null,_timer:0,init:function(a){for(var b in this)a.hasOwnProperty(b)&&(this[b]=a[b]);this._loadScript(),this.navigator(),this.summary(),this._initHistory(),this._initSet(),this._timer=setInterval(function(){mboard.summary()},this.interval)},_scripts:["charts/loader.js","charts/monitorchart.min.js"],_loadScript:function(){for(var a="/static/",b=this._scripts,c=0;c<b.length;c++)$.getScript(a+b[c])},navigator:function(){$.get("/navlist",{},this.navCallback)},_serStatus:{},navHandler:function(a){var b,c,d=$.parseJSON(a),e="";for(var f in d)"string"==typeof d[f]?(b=d[f],c=!0):(b=d[f][0],c=!1),this._serStatus[b]=c,e+=['<li><a href="javascript: void(0);" onclick="mboard.detail(\'',b,"');\">",b,"</a></li>"].join("");var g=this.nav;"string"==typeof g&&(g=$(g)),g.html(e)},summary:function(){$.get("/summary",{type:"poin"},this.summaryCallback)},summaryHandler:function(a){var b,c,d,e,f,g=$.parseJSON(a),h="";for(var i in g)b=g[i],c=b.stat,e="正常",f="",mboard._serStatus[b.server]="error"!==c,"error"===c&&(c={cpuprct:"-",vmem:{percent:"-"}},e="错误",f=' class="err-tr"'),d=b.db,h+=["<tr",f,'><td class="cell_c">',b.server,'</td><td class="cell_c">',switchPrct(c.cpuprct),'</td><td class="cell_c">',switchPrct(c.vmem.percent),'</td><td class="cell_c">',switchUndef(d.tps),'</td><td class="cell_c">',switchUndef(d.avgresp),'</td><td class="cell_c">',switchPrct(d.feedsuc),'</td><td class="cell_c">',e,"</td></tr>"].join("");h=this._content.replace(/\$\{content\}/,h);var j=this.summaryEl;"string"==typeof j&&(j=$(j)),j.html(h)},detail:function(a){return $(".nav.nav-sidebar > li").each(function(){var b=$(this),c=b.children("a");if(c.text()===a){if(b.hasClass("active"))return;b.addClass("active")}else b.removeClass("active")}),mboard._serStatus[a]?(clearInterval(mboard._timer),monitor.init({dispEl:"div.main",freshCallback:function(a){monitor.express(a)},createCallback:function(a){monitor.create(a)},serverName:a}),void $(mboard.historyEl).removeClass("hide")):void $(".alert-danger").removeClass("hide")},_initHistory:function(){"string"==typeof this.historyEl&&(this.historyEl=$(this.historyEl)),this.historyEl.click(this.history)},history:function(){monitor.loadHistory()},_initSet:function(){setter.create({setEl:this.setEl})}}},mboard=new MainBoard,MonitorBoard=function(){return{version:"Monitor Board 1.0.0",_content:['<h1 class="page-header"></h1>','<div class="page-btn hide">','<input type="text" class="his-date" readonly>','<button type="button" class="btn btn-sm btn-primary forward">&lt;&lt; 前4小时</button>','<button type="button" class="btn btn-sm btn-primary backward">后4小时 &gt;&gt;</button>',"</div>",'<div class="mon-info">','<div class="mon-div cpu-info">','<h2 class="sub-header sub-header-p">','<div class="title-text">CPU</div>','<div class="humanized cpu-percent"></div>','<div class="title-text">内存</div>','<div class="humanized mem-percent"></div>',"</h2>",'<div id="sys_chart" class="normal-chart"></div>',"</div>",'<div class="mon-div tps-info">','<h2 class="sub-header sub-header-p">','<div class="title-text">TPS</div>','<div class="humanized tps-val"></div>',"</h2>",'<div id="tps_chart" class="normal-chart"></div>',"</div>",'<div class="mon-div avr-info">','<h2 class="sub-header sub-header-p">','<div class="title-text long-text">平均响应时间</div>','<div class="humanized avr-val"></div>',"</h2>",'<div id="avr_chart" class="normal-chart"></div>',"</div>",'<div class="mon-div suc-info">','<h2 class="sub-header sub-header-p">','<div class="title-text long-text">报文返回成功率</div>','<div class="humanized suc-val"></div>',"</h2>",'<div id="suc_chart" class="normal-chart"></div>',"</div>","</div>",'<div class="detail-panel">','<div class="cpu-info" style="display: none;">',"<h4>CPU</h4>",'<table class="mon-tab"></table>',"</div>",'<div class="mem-info" style="display: none;">',"<h4>Memory</h4>",'<table class="mon-tab"></table>',"</div>","</div>"].join(""),dispEl:null,freshCallback:null,createCallback:null,serverName:null,interval:6e4,_timer:0,init:function(a){for(var b in this)this.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(this[b]=a[b]);this._loaded||(this.dispEl&&"string"==typeof this.dispEl&&(this.dispEl=$(this.dispEl)),this.dispEl.html(this._content),this.dispEl.addClass("chart-container"),$(".btn-primary.forward").click(function(){monitor.loadHistory("f")}),$(".btn-primary.backward").click(function(){monitor.loadHistory("b")})),this._initDisp(),this.fresh(),this._initChart(),this._timer>0&&clearInterval(this._timer),this._timer=setInterval(function(){monitor.fresh()},this.interval)},_initDisp:function(){$("h1.page-header").text(this.serverName),$(".humanized").each(function(){$(this).removeClass("hide")}),$(".page-btn").addClass("hide")},_sysChart:null,_tpsChart:null,_avrChart:null,_sucChart:null,_loaded:!1,create:function(a){a=$.parseJSON(a),this._loaded?this._reloadChart(a):(this._sysChart=mchart({id:"cpu&mem",googleChartOpt:{vAxis:{minValue:0,maxValue:100},lineWidth:.7,areaOpacity:.5,colors:["#418CD8","#899F00"]},dispEl:document.getElementById("sys_chart"),data:a.svr,index:[0,1],illustration:["","CPU","内存"],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._sysChart.draw()}}),this._tpsChart=mchart({id:"tps",googleChartOpt:{vAxis:{minValue:0},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#FF7E40"]},dispEl:document.getElementById("tps_chart"),data:a.db,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._tpsChart.draw()}}),this._avrChart=mchart({id:"averagetime",googleChartOpt:{vAxis:{minValue:0},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#45C098"]},dispEl:document.getElementById("avr_chart"),data:a.db,index:1,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._avrChart.draw()}}),this._sucChart=mchart({id:"successrate",googleChartOpt:{vAxis:{minValue:0,maxValue:100},legend:"left",lineWidth:.7,areaOpacity:.5,colors:["#5500AA"]},dispEl:document.getElementById("suc_chart"),data:a.db,index:2,illustration:["",""],start:a.shour,ctime:[a.ehour,a.eminu],onLoadCallback:function(){monitor._sucChart.draw()}}),this._loaded=!0)},_initChart:function(){$.get("/history/"+this.serverName,{},this.createCallback)},_reloadChart:function(a){this._sysChart.reload({data:a.svr,start:a.shour,ctime:[a.ehour,a.eminu]});var b={data:a.db,start:a.shour,ctime:[a.ehour,a.eminu]};this._tpsChart.reload(b),this._avrChart.reload(b),this._sucChart.reload(b)},fresh:function(){$.get("/serverinfo/"+this.serverName,{},this.freshCallback)},_cpu_prct:0,_mem_prct:0,express:function(a){var b=$.parseJSON(a),c=b.stat,d=b.db;this._switchCpu(c),this._switchMem(c.vmem),this._swichQualify(d),this._freshChart(this._sysChart,[this._cpu_prct,this._mem_prct]),this._freshChart(this._tpsChart,d.tps),this._freshChart(this._avrChart,d.avgresp),this._freshChart(this._sucChart,d.feedsuc)},_freshChart:function(a,b){a&&a.loaded&&a.fresh(b)},_switchCpu:function(a){$(".cpu-percent").text(switchPrct(a.cpuprct)),this._cpu_prct=a.cpuprct;var b="",c=a.cputimes;for(var d in c)b+='<tr><th width="100px">'+d+'</th><td class="cell_r">'+toPrec(c[d],2)+"</td></tr>";$(".cpu-info > .mon-tab").html(b)},_mem_dict:["total","used","free"],_switchMem:function(a){$(".mem-percent").text(switchPrct(a.percent)),this._mem_prct=a.percent,delete a.percent;for(var b="",c=this._mem_dict,d=0;d<c.length&&a[c[d]];d++)b+='<tr><th width="100px">'+c[d]+'</th><td class="cell_r">'+calc(a[c[d]])+"</td></tr>",delete a[c[d]];for(var e in a)b+='<tr><th width="100px">'+e+'</th><td class="cell_r">'+calc(a[e])+"</td></tr>";$(".mem-info > .mon-tab").html(b)},_swichQualify:function(a){$(".tps-val").text(switchUndef(a.tps)),$(".avr-val").text(switchUndef(a.avgresp)+" ms"),$(".suc-val").text(switchPrct(a.feedsuc))},_historyStart:"",loadHistory:function(a){void 0===a&&(this._addHistoryTitle(),this._historyStart="",a=""),$.post("/history",['{"svr_nm":"',this.serverName,'","start":"',this._historyStart,'","direct":"',a,'"}'].join(""),function(a){monitor._historyCallback(a)})},_historyCallback:function(a){"string"==typeof a&&(a=$.parseJSON(a)),this._historyStart=a.stime;var b=parseInt(this._historyStart.substring(8,10));0===b?a.shour=20:a.shour=b-4,a.ehour=b,a.eminu=0,this._reloadChart(a);var c=$(".his-date");c.datepicker(),c.datepicker("option","dateFormat","yy-mm-dd");var d=this._historyStart.substring(0,4),e=this._historyStart.substring(4,6),f=this._historyStart.substring(6,8),g=this._historyStart.substring(8),h=0;"00"===g&&(h=-1);var i=changeDate([d,e,f].join("-"),h);c.val(i)},_addHistoryTitle:function(){clearInterval(this._timer),$("h1.page-header").text("历史记录 - "+this.serverName),$(".humanized").each(function(){$(this).addClass("hide")}),$(".page-btn").removeClass("hide"),$(".his-date").change(function(){monitor._historyStart=this.value.replace(/-/g,"")+"08",monitor.loadHistory("f")})}}},monitor=new MonitorBoard,SetBoard=function(){return{version:"Set Board v1.0.0",_content:['<div class="panel panel-primary set-board" style="display: none">','<div class="panel-heading">','<h3 class="panel-title">设置</h3>',"</div>",'<h3 style="text-align: center;">受控机管理</h3>','<div class="panel-body set-list"></div>','<div class="set-panel-bottom">','<button type="button" class="btn btn-sm btn-info btn-save">保存</button>','<button type="button" class="btn btn-sm btn-info btn-add">新增</button>','<button type="button" class="btn btn-sm btn-default btn-cancle">关闭</button>',"</div>",'<div class="alert hide hint-bar" role="alert"></div>',"</div>"].join(""),setEl:null,create:function(a){var b=this;for(var c in b)a.hasOwnProperty(c)&&(b[c]=a[c]);$("body").append(b._content);var d=$(".set-board"),e=window.screen.width-d.width()-5;d.offset({left:e}),"string"==typeof b.setEl&&(b.setEl=$(b.setEl)),b.setEl.click(function(){$("div.hint-bar").addClass("hide"),d.toggle("fast",function(){b.setHandler()})}),$(".btn-save").click(function(){setter._save()}),$(".btn-add").click(function(){setter._add()}),$(".btn-cancle").click(function(){setter._close()})},_opened:!1,setHandler:function(){return this._opened=!this._opened,this._opened===!1?void $(".panel-body").html(""):void $.post("/setter",{type:"query"},function(a){"string"==typeof a&&(a=$.parseJSON(a));var b='<table class="table host-list" style="width: 90%; margin: auto;"><tbody>';for(var c in a)b+=['<tr><td class="cell_c" width=""><input type="hidden" value="',a[c].server,'">',a[c].server,'</td><td><input type="text" style="text-align: center;" size="13" value="',a[c].host,'"><strong> : </strong><input type="text" style="text-align: center;" size="4" value="',a[c].port,'"></td><td><strong class="btn-del" title="删除">X</strong>',"</td></tr>"].join("");b+="</tbody></table>",$(".panel-body").html(b),$(".btn-del").each(function(){$(this).click(function(){setter._del(this)})})},"json")},_hint:function(a,b){b||(b="f");var c="",d=$("div.hint-bar");"s"===b?(c=["<strong>",a,"</strong>"].join(""),d.removeClass("alert-danger hide").addClass("alert-success")):(c=["<strong>错误！</strong>",a].join(""),d.removeClass("alert-success hide").addClass("alert-danger")),d.html(c)},_save:function(){var a=this,b="[",c=!0;$(".panel-body :text, .panel-body :hidden").each(function(d){var e=this.value.trim();if(""===e)return a._hint("不能包含空值"),c=!1,!1;if(d%3===0)b+='{"server":"'+e+'",';else if(d%3===1){if(!verifyIPv4(e))return a._hint("IP地址格式不正确"),c=!1,!1;b+='"host":"'+e+'",'}else{if(!verifyPort(e))return a._hint("端口应为0-65535之间的数字"),c=!1,!1;b+='"port":'+e+"},"}}),c&&(b=b.replace(/,?$/,"]"),$.post("/setter",{type:"save",data:b},function(b){"string"==typeof b&&(b=$.parseJSON(b)),"ok"===b.status?(a._hint("保存成功","s"),$(".panel-body :text, .panel-body :hidden").each(function(a){if(a%3>0||"text"!==this.getAttribute("type"))return!0;var b=this.value;$(this).parent().html(['<input type="hidden" value="',b,'">',b].join(""))})):a._hint("保存失败")},"json"))},_add:function(){var a=['<tr><td class="cell_c" width=""><input type="text" value=""></td>','<td><input type="text" style="text-align: center;" size="13" value="">','<strong> : </strong><input type="text" style="text-align: center;" size="4" value=""></td>','<td><strong class="btn-del" title="删除">X</strong></td></tr>'].join("");$("table.host-list > tbody").append(a),$("table.host-list > tbody td:last > .btn-del").click(function(){setter._del(this)})},_del:function(a){$(a).parent().parent().remove()},_close:function(){this._opened&&($(".set-board").css("display","none"),$(".panel-body").html(""),this._opened=!1)}}},setter=new SetBoard;