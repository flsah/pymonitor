<!DOCTYPE html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href='{{ static_url("favicon.ico") }}'>

    <title>远程服务器性能监控 - {{ svrname }}</title>

    <!-- Bootstrap core CSS -->
    <link href='{{ static_url("css/bootstrap.min.css") }}' rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href='{{ static_url("css/monitor.min.css") }}' rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <script src='{{ static_url("js/ie-adapter.min.js") }}'></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src='{{ static_url("js/html5shiv.min.js") }}'></script>
    <script src='{{ static_url("js/respond.min.js") }}'></script>
    <![endif]-->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src='{{ static_url("js/jquery.min.js") }}'></script>
    <script src='{{ static_url("js/bootstrap.min.js") }}'></script>
    <!-- Monitoring charts -->
    <script src='{{ static_url("charts/loader.js") }}'></script>
    <script src='{{ static_url("charts/monitorchart.min.js") }}'></script>
    <script src='{{ static_url("js/monitorboard.js") }}'></script>

    <script type="text/javascript">
        function getNavlist() {
            $.get("/navlist", {}, function(data) {
                var nav = $.parseJSON(data);
                var html = '';
                for (var n in nav) {
                    if (nav[n] == '{{ svrname }}') {
                        html += '<li class="active"><a href="#">{{ svrname }}<span class="sr-only">(current)</span></a></li>'
                    } else {
                        html += '<li><a href="/detail/' + nav[n] + '">' + nav[n] + '</a></li>'
                    }
                }
                $("ul.nav.nav-sidebar").html(html);
            });
        }

        var _cpu_prct, _mem_prct;
        function exp(data) {
            var mon_info = $.parseJSON(data);
            var stat = mon_info['stat'], db = mon_info['db'];

            switchCpu(stat);
            switchMem(stat['vmem']);
            swichQualify(db);

            freshChart(sysChart, [_cpu_prct, _mem_prct]);
            freshChart(tpsChart, db['tps']);
            freshChart(avrChart, db['avgresp']);
            freshChart(sucChart, db['feedsuc']);
        }

        function freshDetail() {
            $.get(decodeURI('/serverinfo/{{ svrname }}'), {}, exp);
        }

        function freshChart(chart, data) {
            if (chart && chart.loaded) {
                chart.fresh(data);
            }
        }

        var _unit = [' B ', ' KB', ' MB', ' GB'];
        function calc(orgi) {
            var scalar = 1024;
            var changed = parseFloat(orgi);

            var i = 0;
            for (; i < 4 && changed >= scalar; i++) {
                changed /= scalar;
            }

            return toPrec(changed, 2) + _unit[i];
        }

        function switchCpu(stat) {
            $('.cpu-percent').text(swichPrct(stat['cpuprct']));
            _cpu_prct = stat['cpuprct'];

            var html = '';
            var cputimes = stat['cputimes'];
            for (var p in cputimes) {
                html += '<tr><th width="100px">' + p
                        + '</th><td class="cell_r">' + toPrec(cputimes[p], 2)
                        + '</td></tr>';
            }

            $('.cpu-info > .mon-tab').html(html);
        }

        var _mem_dict = ['total', 'used', 'free']
        function switchMem(vmem) {
            $('.mem-percent').text(swichPrct(vmem['percent']));
            _mem_prct = vmem['percent'];
            delete vmem['percent'];

            var html = '';
            for (var i = 0; i < _mem_dict.length && vmem[_mem_dict[i]]; i++) {
                html += '<tr><th width="100px">' + _mem_dict[i]
                        + '</th><td class="cell_r">' + calc(vmem[_mem_dict[i]])
                        + '</td></tr>';
                delete vmem[_mem_dict[i]];
            }

            for (var p in vmem) {
                html += '<tr><th width="100px">' + p
                        + '</th><td class="cell_r">' + calc(vmem[p])
                        + '</td></tr>';
            }

            $('.mem-info > .mon-tab').html(html);
        }

        function swichQualify(qual) {
            $('.tps-val').text(qual['tps']);
            $('.avr-val').text(qual['avgresp'] + ' ms');
            $('.suc-val').text(qual['feedsuc'] + ' %');
        }

        function swichPrct(prct) {
            if (isNaN(prct)) {
                return "0.0%";
            }

            prct = parseFloat(prct);
            if (prct == 0) {
                return "0.0 %";
            }

            return toPrec(prct) + ' %';
        }

        function toPrec(num, prec) {
            if (!prec) {
                prec = 1;
            }

            eval('num = (Math.round(num * 1e' + prec
                    + ') / 1e' + prec + ').toString()');

            if (prec > 0) {
                if (num.indexOf('.') < 0) {
                    num += '.';
                }

                var pos = num.substring(num.indexOf('.')).length - 1;
                if (pos < prec) {
                    for (var i = 0; i < prec - pos; i++) {
                        num += "0";
                    }
                }
            }

            return num;
        }

        var sysChart, tpsChart, avrChart, sucChart;
        var board;
        $().ready(function() {
            getNavlist();
            board = new MonitorBoard();
            board.init({
                dispEle: 'div.main'
            });
            freshDetail();

            $.get('/history/{{ svrname }}', {}, function(data) {
                data = $.parseJSON(data);

                sysChart = mchart({
                    id: 'cpu&mem',
                    googleChartOpt: {
                        vAxis: {
                            minValue: 0,
                            maxValue: 100
                        },
                        lineWidth: 0.7,
                        areaOpacity: 0.5,
                        colors: ['#418CD8', '#80FF80']
                    },
                    dispEle: document.getElementById('sys_chart'),
                    data: data['svr'],
                    index: [0, 1],
                    illustration: ['', 'CPU', '内存'],
                    start: data['shour'],
                    ctime: [data['ehour'], data['eminu']],
                    onLoadCallback: function() {
                        sysChart.draw();
                    }
                });

                tpsChart = mchart({
                    id: 'tps',
                    googleChartOpt: {
                        vAxis: {
                            minValue: 0,
                        },
                        legend: 'left',
                        lineWidth: 0.7,
                        areaOpacity: 0.4,
                        colors: ['#FF7E40']
                    },
                    dispEle: document.getElementById('tps_chart'),
                    data: data['db'],
                    illustration: ['', ''],
                    start: data['shour'],
                    ctime: [data['ehour'], data['eminu']],
                    onLoadCallback: function() {
                        tpsChart.draw();
                    }
                });

                avrChart = mchart({
                    id: 'averagetime',
                    googleChartOpt: {
                        vAxis: {
                            minValue: 0,
                        },
                        legend: 'left',
                        lineWidth: 0.7,
                        areaOpacity: 0.4,
                        colors: ['#45C098']
                    },
                    dispEle: document.getElementById('avr_chart'),
                    data: data['db'],
                    index: 1,
                    illustration: ['', ''],
                    start: data['shour'],
                    ctime: [data['ehour'], data['eminu']],
                    onLoadCallback: function() {
                        avrChart.draw();
                    }
                });

                sucChart = mchart({
                    id: 'successrate',
                    googleChartOpt: {
                        vAxis: {
                            minValue: 0,
                            maxValue: 100
                        },
                        legend: 'left',
                        lineWidth: 0.7,
                        areaOpacity: 0.4,
                        colors: ['#5500AA']
                    },
                    dispEle: document.getElementById('suc_chart'),
                    data: data['db'],
                    index: 2,
                    illustration: ['', ''],
                    start: data['shour'],
                    ctime: [data['ehour'], data['eminu']],
                    onLoadCallback: function() {
                        sucChart.draw();
                    }
                });
            });

            setInterval(freshDetail, 60000);
        });
    </script>
</head>

<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">远程服务器性能监控</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="/">首页</a></li>
                <li><a href="#">设置</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <ul class="nav nav-sidebar">
                <li class="active"><a href="#"><span class="sr-only">(current)</span></a></li>
            </ul>
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main chart-container">
        </div>
    </div>
</div>
</body>
</html>
